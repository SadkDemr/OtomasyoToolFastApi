<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒ∞≈ü Paketleri Y√∂netimi</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* LAYOUT & GENEL */
        .jobs-layout { display: grid; grid-template-columns: 320px 1fr; gap: 20px; height: calc(100vh - 80px); padding: 20px; box-sizing: border-box; }
        
        /* SOL Lƒ∞STE */
        .job-list-panel { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .list-header { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--bg-primary); }
        .job-list { flex: 1; overflow-y: auto; padding: 10px; }
        
        .job-card { background: var(--bg-primary); border: 1px solid transparent; border-radius: 8px; padding: 15px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; position: relative; }
        .job-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-color: var(--border-color); }
        .job-card.active { background: rgba(59, 130, 246, 0.08); border-color: var(--accent-primary); }
        .job-card.active::before { content:''; position: absolute; left: 0; top: 10px; bottom: 10px; width: 4px; background: var(--accent-primary); border-radius: 0 4px 4px 0; }
        
        /* SAƒû DETAY */
        .job-detail-panel { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; display: none; flex-direction: column; overflow: hidden; height: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .detail-header { padding: 20px 25px; background: var(--bg-primary); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: start; }
        .detail-title h2 { font-size: 1.4rem; margin: 0 0 5px 0; color: var(--text-primary); }
        
        /* TABS */
        .tabs { display: flex; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); padding: 0 25px; gap: 25px; }
        .tab { padding: 15px 0; cursor: pointer; font-size: 0.95rem; font-weight: 600; color: var(--text-muted); border-bottom: 3px solid transparent; transition: all 0.2s; }
        .tab.active { color: var(--accent-primary); border-bottom-color: var(--accent-primary); }
        .tab-content { display: none; padding: 0; flex: 1; overflow-y: auto; background: var(--bg-primary); }
        .tab-content.active { display: block; }

        /* LOG TERMINAL */
        .log-terminal { background: #1e1e1e; color: #d4d4d4; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; height: 100%; padding: 20px; overflow-y: auto; }
        .history-entry { margin-bottom: 25px; border: 1px solid #333; border-radius: 8px; overflow: hidden; }
        .history-header { background: #252526; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid #333; }
        .log-body { padding: 10px; background: #1e1e1e; display: none; }
        .history-entry.open .log-body { display: block; }
        
        .status-badge { padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .st-passed { background: #0e2f18; color: #4ec9b0; border: 1px solid #4ec9b0; }
        .st-failed { background: #2f0e0e; color: #f14c4c; border: 1px solid #f14c4c; }
        .st-running { background: #0e1e2f; color: #569cd6; border: 1px solid #569cd6; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        .scenario-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px; padding: 25px; }
        .chip { background: var(--bg-secondary); padding: 12px 15px; border-radius: 8px; border: 1px solid var(--border-color); display: flex; align-items: center; gap: 10px; }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal { background: var(--bg-secondary); border-radius: 12px; width: 500px; padding: 25px; border: 1px solid var(--border-color); box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header"><div class="logo"><div class="logo-icon">üß™</div><span>Test Platform</span></div></div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Ana Men√º</div>
                    <a href="index.html" class="nav-item"><span class="nav-item-icon">üìä</span><span>Dashboard</span></a>
                    <a href="scenarios.html" class="nav-item"><span class="nav-item-icon">üìù</span><span>Senaryolar</span></a>
                    <a href="jobs.html" class="nav-item active"><span class="nav-item-icon">üöÄ</span><span>ƒ∞≈ü Paketleri</span></a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Test T√ºrleri</div>
                    <a href="web-test.html" class="nav-item"><span class="nav-item-icon">üåê</span><span>Web Test</span></a>
                    <a href="mobile-test.html" class="nav-item"><span class="nav-item-icon">üì≤</span><span>Mobil Test</span></a>
                </div>
            </nav>
            <div class="sidebar-footer"><div class="user-info" onclick="if(confirm('√áƒ±kƒ±≈ü?')) Auth.logout();"><div class="user-avatar">?</div><div class="user-details"><div class="user-name">Admin</div><div class="user-role">Tester</div></div></div></div>
        </aside>

        <main class="main-content">
<header class="header">
                <h1 class="page-title">ƒ∞≈ü Paketleri Y√∂netimi</h1>
                <div class="header-right">
                    <button class="theme-toggle" onclick="if(typeof Theme !== 'undefined') Theme.toggle()">üåô</button>
                    <button class="btn btn-primary" onclick="openCreateModal()" style="cursor: pointer; z-index: 1000; position: relative;">
                        <span class="material-icons-round">add</span> Yeni Job Olu≈ütur
                    </button>
                </div>
            </header>

            <div class="jobs-layout">
                <div class="job-list-panel">
                    <div class="list-header">
                        <span style="font-weight:600; color:var(--text-secondary);">Paket Listesi</span>
                        <button class="icon-btn" onclick="loadJobs()"><span class="material-icons-round">refresh</span></button>
                    </div>
                    <div class="job-list" id="jobList"></div>
                </div>

                <div class="job-detail-panel" id="jobDetail">
                    <div class="detail-header">
                        <div class="detail-title">
                            <h2 id="detailName">-</h2>
                            <p id="detailDesc" style="color:var(--text-muted); margin:0;">-</p>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-ghost" onclick="openEditModal()">D√ºzenle</button>
                            <button class="btn btn-danger" onclick="deleteCurrentJob()">Sil</button>
                            <button class="btn btn-danger" style="background:rgba(220,38,38,0.1); color:#dc2626; border:1px solid rgba(220,38,38,0.2);" onclick="stopCurrentJob()">
                                <span class="material-icons-round">stop</span> Durdur
                            </button>
                            <button class="btn btn-primary" onclick="runCurrentJob()">
                                <span class="material-icons-round">play_arrow</span> Ba≈ülat
                            </button>
                        </div>
                    </div>

                    <div class="tabs">
                        <div class="tab active" onclick="switchTab('details')">Genel Bakƒ±≈ü</div>
                        <div class="tab" onclick="switchTab('history')">Terminal & Loglar</div>
                    </div>

                    <div id="tab-details" class="tab-content active">
                        <div class="scenario-grid" id="detailScenarios"></div>
                    </div>

                    <div id="tab-history" class="tab-content" style="padding:0; background:#1e1e1e;">
                        <div class="log-terminal" id="historyList">
                            <div style="text-align:center; padding-top:50px; color:#555;">Log verisi yok.</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="jobModal">
        <div class="modal">
            <h3 id="modalTitle" style="margin-top:0;">Job Olu≈ütur</h3>
            <input type="hidden" id="editJobId">
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px; font-weight:500;">Paket Adƒ±</label>
                <input type="text" id="jobNameInput" class="form-input" style="width:100%;">
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px; font-weight:500;">A√ßƒ±klama</label>
                <input type="text" id="jobDescInput" class="form-input" style="width:100%;">
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:5px; font-weight:500;">Senaryolar</label>
                <div id="modalScenarios" style="max-height:200px; overflow-y:auto; border:1px solid var(--border-color); padding:10px; border-radius:8px;"></div>
            </div>
            <div style="text-align:right; display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-ghost" onclick="closeModal()">ƒ∞ptal</button>
                <button class="btn btn-primary" onclick="saveJob()">Kaydet</button>
            </div>
        </div>
    </div>

<script src="js/app.js"></script>
    <script>
        // Global deƒüi≈ükenleri g√ºvenli ba≈ülat
        let allJobs = [];
        let allScenarios = [];
        let selectedJobId = null;

        // Sayfa Y√ºklendiƒüinde
        document.addEventListener('DOMContentLoaded', async () => {
            if(typeof Auth !== 'undefined' && !Auth.checkAuth()) return;
            if(typeof UI !== 'undefined') UI.renderUserInfo();
            
            // Hatalarƒ± yutarak y√ºkle ki sayfa kilitlenmesin
            try { await loadScenarios(); } catch(e) { console.error("Senaryo hatasƒ±:", e); allScenarios = []; }
            try { await loadJobs(); } catch(e) { console.error("Job hatasƒ±:", e); allJobs = []; }
        });

        // --- VERƒ∞ √áEKME ---
        async function loadJobs() {
            try {
                const res = await API.get('/jobs');
                allJobs = Array.isArray(res) ? res : [];
                renderJobList();
            } catch(e) { 
                console.error("Job listesi alƒ±namadƒ±", e);
                allJobs = [];
                renderJobList();
            }
        }
        
        async function loadScenarios() {
            try {
                const r = await ScenariosAPI.list();
                // API'den gelen veri yapƒ±sƒ±na g√∂re senaryolarƒ± al
                allScenarios = (r && Array.isArray(r.scenarios)) ? r.scenarios : [];
            } catch(e) { 
                console.error("Senaryolar alƒ±namadƒ±", e);
                allScenarios = [];
            }
        }

        // --- MODAL ƒ∞≈ûLEMLERƒ∞ ---
        function openCreateModal() {
            console.log("Yeni Job butonu tƒ±klandƒ±.");
            prepareModal(null);
        }

        function openEditModal() { 
            if(selectedJobId) prepareModal(selectedJobId); 
        }

        function prepareModal(jobId) {
            const modal = document.getElementById('jobModal');
            if(!modal) { alert("Modal bulunamadƒ±!"); return; }
            
            modal.style.display = 'flex';

            const isEdit = !!jobId;
            document.getElementById('modalTitle').textContent = isEdit ? 'Job D√ºzenle' : 'Job Olu≈ütur';
            document.getElementById('editJobId').value = jobId || '';
            
            // Formu temizle
            document.getElementById('jobNameInput').value = '';
            document.getElementById('jobDescInput').value = '';
            
            // Edit ise verileri doldur
            let currentScenarios = [];
            if(jobId) {
                const job = allJobs.find(j => j.id === jobId);
                if(job) {
                    document.getElementById('jobNameInput').value = job.name || '';
                    document.getElementById('jobDescInput').value = job.description || '';
                    currentScenarios = job.scenarios || [];
                }
            }

            // Senaryo listesini olu≈ütur (Hata korumalƒ±)
            const list = document.getElementById('modalScenarios');
            const safeList = Array.isArray(allScenarios) ? allScenarios : [];
            
            if (safeList.length === 0) {
                list.innerHTML = '<div style="padding:15px; text-align:center; color:#888;">Listelenecek senaryo yok.</div>';
            } else {
                list.innerHTML = safeList.map(s => {
                    // Eƒüer job d√ºzenleniyorsa ve senaryo se√ßiliyse i≈üaretle
                    const isChecked = currentScenarios.some(cs => cs.id === s.id) ? 'checked' : '';
                    return `
                    <div style="padding:8px; border-bottom:1px solid var(--border-color); display:flex; align-items:center;">
                        <label style="cursor:pointer; display:flex; align-items:center; gap:10px; width:100%;">
                            <input type="checkbox" value="${s.id}" ${isChecked} style="width:16px; height:16px;"> 
                            <span class="material-icons-round" style="font-size:18px; color:var(--text-secondary);">${s.type==='mobile'?'smartphone':'language'}</span>
                            <span>${s.name}</span>
                        </label>
                    </div>`;
                }).join('');
            }
        }

        function closeModal() {
            document.getElementById('jobModal').style.display = 'none';
        }

        async function saveJob() {
            const id = document.getElementById('editJobId').value;
            const name = document.getElementById('jobNameInput').value;
            const desc = document.getElementById('jobDescInput').value;
            
            if(!name) { alert("L√ºtfen paket adƒ± girin"); return; }

            const checkboxes = document.querySelectorAll('#modalScenarios input:checked');
            const scenarioIds = Array.from(checkboxes).map(c => parseInt(c.value));
            const data = { name: name, description: desc, scenario_ids: scenarioIds };

            try {
                if(id) await API.put(`/jobs/${id}`, data);
                else await API.post('/jobs', data);
                
                closeModal();
                await loadJobs();
                if(id) selectJob(parseInt(id));
            } catch(e) { alert("Kaydetme hatasƒ±: " + e.message); }
        }

        // --- ARAY√úZ FONKSƒ∞YONLARI ---
        function renderJobList() {
            const list = document.getElementById('jobList');
            if(!list) return;

            if(!allJobs || allJobs.length === 0) {
                list.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-muted);">Kayƒ±tlƒ± paket yok.</div>';
                return;
            }

            list.innerHTML = allJobs.map(j => `
                <div class="job-card ${selectedJobId === j.id ? 'active' : ''}" onclick="selectJob(${j.id})">
                    <div style="font-weight:600;">${j.name}</div>
                    <div style="font-size:0.8rem; color:var(--text-secondary); margin-top:5px; display:flex; justify-content:space-between;">
                        <span>${j.scenarios ? j.scenarios.length : 0} Senaryo</span>
                        <span>${new Date(j.created_at).toLocaleDateString()}</span>
                    </div>
                </div>
            `).join('');
        }

        function selectJob(id) {
            selectedJobId = id;
            renderJobList();
            const job = allJobs.find(j => j.id === id);
            if(!job) return;

            document.getElementById('jobDetail').style.display = 'flex';
            document.getElementById('detailName').textContent = job.name;
            document.getElementById('detailDesc').textContent = job.description || '-';

            const cont = document.getElementById('detailScenarios');
            const scenList = job.scenarios || [];
            
            if(scenList.length === 0) {
                cont.innerHTML = '<span style="color:var(--text-muted);">Bu pakette senaryo yok.</span>';
            } else {
                cont.innerHTML = scenList.map(s => `
                    <div class="chip">
                        <span class="material-icons-round" style="font-size:1rem; color:var(--accent-primary);">${s.type==='mobile'?'smartphone':'language'}</span>
                        ${s.name}
                    </div>
                `).join('');
            }

            // Eƒüer history tabƒ± a√ßƒ±ksa loglarƒ± g√ºncelle
            if(document.querySelector('.tab[onclick*="history"]').classList.contains('active')) {
                loadHistory();
            }
        }

        // --- LOGLAR VE HISTORY ---
        async function loadHistory() {
            if(!selectedJobId) return;
            const container = document.getElementById('historyList');
            try {
                const history = await API.get(`/jobs/${selectedJobId}/history`);
                if(!history || !history.length) {
                    container.innerHTML = '<div style="text-align:center; padding:30px; color:#666;">Hen√ºz ko≈üum kaydƒ± yok.</div>';
                    return;
                }
                
                container.innerHTML = history.map(h => `
                    <div class="history-entry" onclick="this.classList.toggle('open')">
                        <div class="history-header">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <span class="status-badge st-${h.status}">${h.status}</span>
                                <span style="font-size:0.8rem; color:#aaa;">${new Date(h.start_time).toLocaleString()}</span>
                            </div>
                            <div style="font-size:0.8rem; font-weight:bold;">
                                <span style="color:#4ec9b0;">Pass: ${h.passed}</span> <span style="color:#f14c4c;">Fail: ${h.failed}</span>
                            </div>
                        </div>
                        <div class="log-body" style="${h.status==='running'?'display:block':''}">
                            ${(h.results || []).map(r => `
                                <div style="margin-bottom:5px; padding-bottom:5px; border-bottom:1px solid #333;">
                                    <strong style="color:#eee;">${r.scenario_name}:</strong> 
                                    <span style="color:${r.status==='passed'?'#4ec9b0':(r.status==='running'?'#569cd6':'#f14c4c')}">${r.status ? r.status.toUpperCase() : 'UNK'}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>`).join('');
            } catch(e) { container.innerHTML = '<div style="padding:20px; color:#f14c4c;">Log hatasƒ±.</div>'; }
        }

        // --- TAB Sƒ∞STEMƒ∞ ---
        function switchTab(t) {
            document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            
            const btn = document.querySelector(`.tab[onclick*="${t}"]`);
            if(btn) btn.classList.add('active');
            
            const content = document.getElementById(`tab-${t}`);
            if(content) content.classList.add('active');

            if(t === 'history') loadHistory();
        }

        // --- BUTON AKSƒ∞YONLARI ---
        async function runCurrentJob() {
            if(!selectedJobId) return;
            if(!confirm('Ba≈ülat?')) return;
            try { await API.post(`/jobs/${selectedJobId}/run`, {}); switchTab('history'); loadHistory(); } catch(e) { alert(e.message); }
        }

        async function stopCurrentJob() {
            if(!selectedJobId) return;
            if(confirm('Durdur?')) { await API.post(`/jobs/${selectedJobId}/stop`, {}); setTimeout(loadHistory, 1000); }
        }

        async function deleteCurrentJob() {
            if(!selectedJobId) return;
            if(confirm('Sil?')) { await API.delete(`/jobs/${selectedJobId}`); window.location.reload(); }
        }

        // --- OTOMATƒ∞K YENƒ∞LEME ---
        setInterval(() => {
            const histTab = document.getElementById('tab-history');
            // Sadece history sekmesi a√ßƒ±ksa ve se√ßili job varsa yenile
            if(selectedJobId && histTab && histTab.classList.contains('active')) {
                // Opsiyonel: Sadece √ßalƒ±≈üan varsa yenilemek i√ßin kontrol eklenebilir
                loadHistory();
            }
        }, 5000);
    </script>
</body>
</html>