<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desktop Test - Test Platformu</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .desktop-layout{display:grid;grid-template-columns:280px 1fr 340px;gap:16px;height:calc(100vh - 100px)}
        .left-panel,.right-panel{display:flex;flex-direction:column;gap:12px;overflow:hidden}
        .center-panel{display:flex;flex-direction:column;gap:12px}
        .card{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:10px;display:flex;flex-direction:column;overflow:hidden}
        .card-header{padding:14px 16px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between;background:var(--bg-tertiary)}
        .card-title{font-weight:600;font-size:.9rem}
        .scenario-tree{flex:1;overflow-y:auto;padding:8px}
        .tree-folder{margin-bottom:2px}
        .tree-folder-header{display:flex;align-items:center;gap:6px;padding:8px 10px;cursor:pointer;font-size:.85rem;font-weight:500;border-radius:6px;color:var(--text-secondary);transition:all .15s}
        .tree-folder-header:hover{background:var(--bg-tertiary);color:var(--text-primary)}
        .tree-folder-content{padding-left:20px;display:none}
        .tree-folder.open>.tree-folder-content{display:block}
        .tree-folder.open>.tree-folder-header .folder-icon{transform:rotate(90deg)}
        .folder-icon{transition:transform .2s;font-size:.9rem}
        .tree-item{padding:8px 10px;margin:2px 0;cursor:pointer;border-radius:6px;font-size:.85rem;display:flex;align-items:center;gap:10px;transition:all .15s}
        .tree-item:hover{background:var(--bg-tertiary)}
        .tree-item.active{background:rgba(139,92,246,.15);color:#8B5CF6;font-weight:600}
        .editor-box{flex:1;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:10px;display:flex;flex-direction:column;overflow:hidden}
        .editor-header{padding:12px 16px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;gap:12px}
        .editor-header input{border:1px solid var(--border-color);background:var(--bg-primary);padding:8px 12px;border-radius:6px;font-weight:500;font-size:.9rem;color:var(--text-primary);flex:1}
        .editor-header input:focus{outline:none;border-color:var(--accent-primary)}
        .editor-body{flex:1;display:flex;flex-direction:column;overflow:hidden}
        .editor-body textarea{flex:1;padding:16px;border:none;background:transparent;color:var(--text-primary);font-family:'JetBrains Mono',monospace;font-size:.85rem;line-height:1.8;resize:none}
        .editor-body textarea:focus{outline:none}
        .editor-footer{padding:12px 16px;border-top:1px solid var(--border-color);display:flex;gap:10px;background:var(--bg-tertiary)}
        .settings-section{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:10px;overflow:hidden}
        .settings-section-header{padding:12px 16px;border-bottom:1px solid var(--border-color);font-weight:600;font-size:.85rem;display:flex;align-items:center;gap:8px;background:var(--bg-tertiary)}
        .settings-section-body{padding:14px 16px}
        .result-box{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:10px;overflow:hidden;flex:1;display:flex;flex-direction:column}
        .result-header{padding:12px 16px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between;font-weight:600;font-size:.85rem;background:var(--bg-tertiary)}
        .result-body{padding:12px;flex:1;overflow-y:auto}
        .result-step{display:flex;align-items:flex-start;gap:10px;padding:10px 12px;border-radius:6px;margin-bottom:6px;background:var(--bg-tertiary)}
        .result-step.success{background:rgba(16,185,129,.1);border-left:3px solid var(--success)}
        .result-step.failed{background:rgba(239,68,68,.1);border-left:3px solid var(--danger)}
        .result-step-num{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:600;background:var(--bg-secondary);flex-shrink:0}
        .result-step.success .result-step-num{background:var(--success);color:#fff}
        .result-step.failed .result-step-num{background:var(--danger);color:#fff}
        .result-step-content{flex:1}
        .result-step-action{font-weight:500;font-size:.85rem}
        .result-step-message{font-size:.75rem;color:var(--text-muted);margin-top:3px}
        .btn{padding:10px 18px;border-radius:8px;border:none;cursor:pointer;font-size:.85rem;font-weight:500;display:inline-flex;align-items:center;gap:6px;transition:all .2s}
        .btn-primary{background:var(--accent-primary);color:#fff}
        .btn-primary:hover{background:var(--accent-hover);transform:translateY(-1px)}
        .btn-secondary{background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border-color)}
        .btn-success{background:var(--success);color:#fff}
        .btn-ghost{background:transparent;color:var(--text-secondary)}
        .btn-ghost:hover{background:var(--bg-tertiary)}
        .btn-icon{background:none;border:none;color:var(--text-secondary);cursor:pointer;padding:6px;border-radius:4px}
        .btn-icon:hover{background:var(--bg-tertiary);color:var(--text-primary)}
        .form-group{margin-bottom:12px}
        .form-label{display:block;font-size:.8rem;font-weight:500;margin-bottom:5px;color:var(--text-secondary)}
        .form-input{width:100%;padding:10px 12px;border:1px solid var(--border-color);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);font-size:.85rem;box-sizing:border-box}
        .form-input:focus{outline:none;border-color:var(--accent-primary)}
        .toggle-group{display:flex;align-items:center;justify-content:space-between;padding:8px 0}
        .toggle-switch{position:relative;width:44px;height:24px}
        .toggle-switch input{opacity:0;width:0;height:0}
        .toggle-slider{position:absolute;cursor:pointer;inset:0;background:var(--bg-tertiary);border-radius:24px;transition:.3s}
        .toggle-slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s}
        .toggle-switch input:checked+.toggle-slider{background:var(--accent-primary)}
        .toggle-switch input:checked+.toggle-slider:before{transform:translateX(20px)}
        .badge{padding:4px 10px;border-radius:20px;font-size:.75rem;font-weight:500}
        .badge-success{background:rgba(16,185,129,.15);color:var(--success)}
        .badge-danger{background:rgba(239,68,68,.15);color:var(--danger)}
        .badge-info{background:rgba(59,130,246,.15);color:var(--info)}
        .help-box{background:rgba(139,92,246,.08);border:1px solid rgba(139,92,246,.2);border-radius:8px;padding:12px;margin-top:10px}
        .help-box h4{font-size:.8rem;color:#8B5CF6;margin-bottom:8px}
        .help-box code{display:block;font-family:'JetBrains Mono',monospace;font-size:.75rem;color:var(--text-secondary);margin:4px 0;padding:4px 8px;background:var(--bg-primary);border-radius:4px}
        .info-banner{background:rgba(139,92,246,.1);border:1px solid rgba(139,92,246,.3);border-radius:10px;padding:20px;margin-bottom:20px;display:flex;align-items:center;gap:16px}
        .info-banner .icon{font-size:2.5rem}
        .info-banner h3{font-size:1rem;font-weight:600;margin-bottom:4px}
        .info-banner p{font-size:.85rem;color:var(--text-secondary)}
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header"><div class="logo"><div class="logo-icon">üß™</div><span>Test Platform</span></div></div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Ana Men√º</div>
                    <a href="index.html" class="nav-item"><span class="nav-item-icon">üìä</span><span>Dashboard</span></a>
                    <a href="scenarios.html" class="nav-item"><span class="nav-item-icon">üìù</span><span>Senaryolar</span></a>
                    <a href="jobs.html" class="nav-item"><span class="nav-item-icon">üöÄ</span><span>ƒ∞≈ü Paketleri</span></a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Test T√ºrleri</div>
                    <a href="web-test.html" class="nav-item"><span class="nav-item-icon">üåê</span><span>Web Test</span></a>
                    <a href="mobile-test.html" class="nav-item"><span class="nav-item-icon">üì≤</span><span>Mobil Test</span></a>
                    <a href="desktop-test.html" class="nav-item active"><span class="nav-item-icon">üñ•Ô∏è</span><span>Desktop Test</span></a>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info" onclick="if(confirm('√áƒ±kƒ±≈ü?')) Auth.logout();">
                    <div class="user-avatar">?</div>
                    <div class="user-details"><div class="user-name">...</div><div class="user-role">...</div></div>
                </div>
            </div>
        </aside>
        
        <main class="main-content">
            <header class="header">
                <div class="header-left"><h1 class="page-title">üñ•Ô∏è Desktop Test</h1></div>
                <div class="header-right">
                    <button class="theme-toggle" onclick="Theme.toggle()">üåô</button>
                </div>
            </header>
            
            <div class="page-content">
                <div class="info-banner">
                    <div class="icon">üñ•Ô∏è</div>
                    <div>
                        <h3>Desktop Uygulama Testi</h3>
                        <p>Windows, macOS ve Linux masa√ºst√º uygulamalarƒ±nƒ± test edin. PyAutoGUI ve WinAppDriver desteƒüi.</p>
                    </div>
                </div>
                
                <div class="desktop-layout">
                    <!-- SOL: SENARYOLAR -->
                    <div class="left-panel">
                        <div class="card" style="flex:1;">
                            <div class="card-header">
                                <h3 class="card-title">üñ•Ô∏è Desktop Senaryolarƒ±</h3>
                                <button class="btn-icon" onclick="loadScenarioTree()" title="Yenile">
                                    <span class="material-icons-round">refresh</span>
                                </button>
                            </div>
                            <div class="scenario-tree" id="scenarioTree">
                                <div style="text-align:center;padding:30px;color:var(--text-muted);">Y√ºkleniyor...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ORTA: EDƒ∞T√ñR -->
                    <div class="center-panel">
                        <div class="editor-box">
                            <div class="editor-header">
                                <input type="text" id="scenarioName" placeholder="Senaryo Adƒ±...">
                                <button class="btn btn-secondary" onclick="newScenario()">
                                    <span class="material-icons-round" style="font-size:1rem;">add</span> Yeni
                                </button>
                                <button class="btn btn-primary" onclick="saveScenario()">
                                    <span class="material-icons-round" style="font-size:1rem;">save</span> Kaydet
                                </button>
                            </div>
                            <div class="editor-body">
                                <textarea id="stepsEditor" placeholder="Desktop test adƒ±mlarƒ±nƒ± buraya yazƒ±n...

√ñrnek Komutlar:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Notepad uygulamasƒ±nƒ± a√ß
‚Ä¢ &quot;Dosya&quot; men√ºs√ºne tƒ±kla
‚Ä¢ &quot;Yeni&quot; se√ßeneƒüine tƒ±kla
‚Ä¢ &quot;Merhaba D√ºnya&quot; yaz
‚Ä¢ Ctrl+S tu≈üuna bas
‚Ä¢ 2 saniye bekle
‚Ä¢ Pencereyi kapat

Koordinat Tabanlƒ±:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ (100, 200) konumuna tƒ±kla
‚Ä¢ (500, 300) konumuna √ßift tƒ±kla
‚Ä¢ (100, 100) den (500, 500) e s√ºr√ºkle
"></textarea>
                            </div>
                            <div class="editor-footer">
                                <button class="btn btn-success" onclick="runTest()" id="btnRun" style="flex:1;">
                                    <span class="material-icons-round">play_arrow</span> Testi √áalƒ±≈ütƒ±r
                                </button>
                                <button class="btn btn-secondary" onclick="stopTest()" id="btnStop" style="display:none;flex:1;">
                                    <span class="material-icons-round">stop</span> Durdur
                                </button>
                            </div>
                        </div>
                        
                        <div class="help-box">
                            <h4>üí° Desktop Komutlarƒ±</h4>
                            <code>"Notepad" uygulamasƒ±nƒ± a√ß</code>
                            <code>"Dosya" men√ºs√ºne tƒ±kla</code>
                            <code>(100, 200) konumuna tƒ±kla</code>
                            <code>Ctrl+S tu≈üuna bas</code>
                        </div>
                    </div>
                    
                    <!-- SAƒû: AYARLAR & SONU√áLAR -->
                    <div class="right-panel">
                        <div class="settings-section">
                            <div class="settings-section-header">
                                <span class="material-icons-round" style="font-size:1.1rem;">settings</span>
                                <span>Test Ayarlarƒ±</span>
                            </div>
                            <div class="settings-section-body">
                                <div class="form-group">
                                    <label class="form-label">Uygulama Yolu</label>
                                    <input type="text" class="form-input" id="appPath" placeholder="C:\Program Files\App\app.exe">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Klas√∂r</label>
                                    <select class="form-input" id="scenarioFolderSelect">
                                        <option value="">Ana Dizin</option>
                                    </select>
                                </div>
                                <div class="toggle-group">
                                    <span style="font-size:.85rem;">Ekran g√∂r√ºnt√ºs√º al</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="takeScreenshots" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-group">
                                    <span style="font-size:.85rem;">Hatada durdur</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="stopOnFail" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="result-box">
                            <div class="result-header">
                                <span>üìä Test Sonu√ßlarƒ±</span>
                                <span class="badge badge-info" id="resultBadge">Bekliyor</span>
                            </div>
                            <div class="result-body" id="resultBody">
                                <div style="text-align:center;padding:40px 20px;color:var(--text-muted);">
                                    <div style="font-size:2.5rem;margin-bottom:10px;opacity:.3;">üñ•Ô∏è</div>
                                    <div style="font-size:.85rem;">Test sonu√ßlarƒ± burada g√∂r√ºnecek</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/app.js"></script>
    <script>
        let allFolders = [];
        let allScenarios = [];
        let selectedScenarioId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            if (!Auth.checkAuth()) return;
            UI.renderUserInfo();
            await init();
        });

        async function init() {
            await loadScenarioTree();
            await loadFolderSelect();
        }

        async function loadScenarioTree() {
            try {
                const foldersRes = await API.get('/scenarios/folders');
                const scenariosRes = await API.get('/scenarios?type=desktop');
                allFolders = foldersRes || [];
                allScenarios = scenariosRes.scenarios || [];
                const html = buildTreeHTML(allFolders, allScenarios, null);
                document.getElementById('scenarioTree').innerHTML = html || '<div style="text-align:center;padding:30px;color:var(--text-muted);"><div style="font-size:2rem;margin-bottom:8px;opacity:.3;">üñ•Ô∏è</div><div style="font-size:.85rem;">Desktop senaryosu yok</div><button class="btn btn-primary" onclick="newScenario()" style="margin-top:12px;padding:8px 16px;font-size:.8rem">+ Yeni Olu≈ütur</button></div>';
            } catch (e) {
                console.error(e);
            }
        }

        function buildTreeHTML(folders, scenarios, parentId) {
            let html = '';
            folders.filter(f => f.parent_id === parentId).forEach(folder => {
                const children = buildTreeHTML(folders, scenarios, folder.id);
                if (children) {
                    html += `<div class="tree-folder"><div class="tree-folder-header" onclick="this.parentElement.classList.toggle('open')"><span class="folder-icon material-icons-round" style="font-size:1rem">chevron_right</span><span class="material-icons-round" style="font-size:1rem;color:#F59E0B">folder</span><span style="flex:1">${folder.name}</span></div><div class="tree-folder-content">${children}</div></div>`;
                }
            });
            scenarios.filter(s => s.folder_id === parentId).forEach(s => {
                html += `<div class="tree-item ${selectedScenarioId === s.id ? 'active' : ''}" onclick="selectScenario(${s.id})"><span class="material-icons-round" style="color:#8B5CF6;font-size:1.1rem">computer</span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${s.name}</span></div>`;
            });
            return html;
        }

        function newScenario() {
            selectedScenarioId = null;
            document.getElementById('scenarioName').value = '';
            document.getElementById('stepsEditor').value = '';
            document.getElementById('appPath').value = '';
            document.getElementById('scenarioFolderSelect').value = '';
            loadScenarioTree();
        }

        async function selectScenario(id) {
            try {
                const s = await ScenariosAPI.get(id);
                selectedScenarioId = s.id;
                document.getElementById('scenarioName').value = s.name;
                document.getElementById('stepsEditor').value = s.natural_steps || '';
                document.getElementById('scenarioFolderSelect').value = s.folder_id || '';
                if (s.config_json) {
                    try {
                        const c = JSON.parse(s.config_json);
                        document.getElementById('appPath').value = c.app_path || '';
                    } catch (e) {}
                }
                loadScenarioTree();
                Toast.success(`"${s.name}" se√ßildi`);
            } catch (e) {
                Toast.error(e.message);
            }
        }

        async function saveScenario() {
            const name = document.getElementById('scenarioName').value.trim();
            if (!name) { Toast.error('Senaryo adƒ± gerekli'); return; }
            const data = {
                name,
                type: 'desktop',
                natural_steps: document.getElementById('stepsEditor').value,
                folder_id: document.getElementById('scenarioFolderSelect').value ? parseInt(document.getElementById('scenarioFolderSelect').value) : null,
                config_json: JSON.stringify({ app_path: document.getElementById('appPath').value, take_screenshots: document.getElementById('takeScreenshots').checked })
            };
            try {
                if (selectedScenarioId) {
                    await ScenariosAPI.update(selectedScenarioId, data);
                    Toast.success('G√ºncellendi');
                } else {
                    const res = await ScenariosAPI.create(data);
                    selectedScenarioId = res.id;
                    Toast.success('Olu≈üturuldu');
                }
                loadScenarioTree();
            } catch (e) {
                Toast.error(e.message);
            }
        }

        async function runTest() {
            Toast.info('Desktop test hen√ºz geli≈ütirme a≈üamasƒ±nda. PyAutoGUI entegrasyonu yakƒ±nda...');
        }

        function stopTest() {
            Toast.info('Test durduruldu');
        }

        async function loadFolderSelect() {
            try {
                const folders = await API.get('/scenarios/folders');
                const select = document.getElementById('scenarioFolderSelect');
                select.innerHTML = '<option value="">Ana Dizin</option>' + flattenFolders(folders);
            } catch (e) {}
        }

        function flattenFolders(nodes, prefix = '') {
            let html = '';
            nodes.forEach(f => {
                html += `<option value="${f.id}">${prefix}üìÇ ${f.name}</option>`;
                if (f.children) html += flattenFolders(f.children, prefix + '&nbsp;&nbsp;');
            });
            return html;
        }
    </script>
</body>
</html>