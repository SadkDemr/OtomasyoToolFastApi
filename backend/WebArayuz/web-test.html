<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Test - Test Otomasyon Platformu</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .web-layout { display: grid; grid-template-columns: 280px 1fr 320px; gap: 16px; height: calc(100vh - 130px); }
        
        .left-panel, .right-panel { display: flex; flex-direction: column; gap: 12px; overflow: hidden; }
        .center-panel { display: flex; flex-direction: column; gap: 12px; }
        
        .scenario-list { flex: 1; overflow-y: auto; }
        .scenario-item {
            padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px;
            margin-bottom: 6px; cursor: pointer; background: var(--bg-secondary);
        }
        .scenario-item:hover { border-color: var(--accent-primary); }
        .scenario-item.selected { border-color: var(--accent-primary); background: rgba(79,70,229,0.05); }
        .scenario-item-name { font-weight: 600; font-size: 0.85rem; margin-bottom: 2px; }
        .scenario-item-meta { font-size: 0.7rem; color: var(--text-muted); }
        
        .editor-box {
            flex: 1; background: var(--bg-secondary); border: 1px solid var(--border-color);
            border-radius: var(--radius-lg); display: flex; flex-direction: column; overflow: hidden;
        }
        .editor-header {
            padding: 12px 16px; border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between;
        }
        .editor-header input {
            border: none; background: none; font-weight: 600; font-size: 1rem;
            color: var(--text-primary); flex: 1; margin-right: 12px;
        }
        .editor-header input:focus { outline: none; }
        
        .editor-body { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .editor-body textarea {
            flex: 1; padding: 16px; border: none; background: transparent;
            color: var(--text-primary); font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem; line-height: 1.8; resize: none;
        }
        .editor-body textarea:focus { outline: none; }
        
        .editor-footer {
            padding: 12px 16px; border-top: 1px solid var(--border-color);
            display: flex; gap: 8px; background: var(--bg-tertiary);
        }
        
        .settings-section {
            background: var(--bg-secondary); border: 1px solid var(--border-color);
            border-radius: var(--radius-lg); overflow: hidden;
        }
        .settings-section-header {
            padding: 10px 14px; border-bottom: 1px solid var(--border-color);
            font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; gap: 8px;
        }
        .settings-section-body { padding: 12px 14px; }
        
        .result-box {
            background: var(--bg-secondary); border: 1px solid var(--border-color);
            border-radius: var(--radius-lg); overflow: hidden; flex: 1;
        }
        .result-header {
            padding: 10px 14px; border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between;
            font-weight: 600; font-size: 0.85rem;
        }
        .result-body { padding: 12px; max-height: 300px; overflow-y: auto; }
        
        .result-step {
            display: flex; align-items: flex-start; gap: 10px;
            padding: 8px 10px; border-radius: 6px; margin-bottom: 6px;
            background: var(--bg-tertiary);
        }
        .result-step.success { background: rgba(16,185,129,0.1); }
        .result-step.failed { background: rgba(239,68,68,0.1); }
        
        .result-step-num {
            width: 24px; height: 24px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.7rem; font-weight: 600; background: var(--bg-secondary);
        }
        .result-step.success .result-step-num { background: var(--success); color: white; }
        .result-step.failed .result-step-num { background: var(--danger); color: white; }
        
        .result-step-content { flex: 1; }
        .result-step-action { font-weight: 500; font-size: 0.8rem; }
        .result-step-message { font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }
        
        .result-step-icon { font-size: 1rem; }
        
        .quick-actions { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; }
        .quick-action {
            padding: 4px 8px; border-radius: 4px; font-size: 0.7rem;
            background: var(--bg-tertiary); color: var(--text-secondary);
            border: 1px solid var(--border-color); cursor: pointer;
        }
        .quick-action:hover { background: var(--bg-hover); color: var(--text-primary); }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo"><div class="logo-icon">üß™</div><span>Test Platform</span></div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Ana Menu</div>
                    <a href="index.html" class="nav-item"><span class="nav-item-icon">üìä</span><span>Dashboard</span></a>
                    <a href="scenarios.html" class="nav-item"><span class="nav-item-icon">üìù</span><span>Senaryolar</span></a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Test Turleri</div>
                    <a href="web-test.html" class="nav-item active"><span class="nav-item-icon">üåê</span><span>Web Test</span></a>
                    <a href="mobile-test.html" class="nav-item"><span class="nav-item-icon">üì≤</span><span>Mobil Test</span></a>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info" onclick="if(confirm('Cikis?')) Auth.logout();">
                    <div class="user-avatar">?</div>
                    <div class="user-details"><div class="user-name">Yukleniyor...</div><div class="user-role">-</div></div>
                </div>
            </div>
        </aside>
        
        <main class="main-content">
            <header class="header">
                <div class="header-left"><h1 class="page-title">Web Test</h1></div>
                <div class="header-right">
                    <button class="theme-toggle" onclick="Theme.toggle()">üåô</button>
                    <button class="btn btn-ghost btn-sm" onclick="Modal.show('helpModal')">‚ùì Yardim</button>
                </div>
            </header>
            
            <div class="page-content">
                <div class="web-layout">
                    <!-- Left Panel - Scenarios -->
                    <div class="left-panel">
                        <div class="card" style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
                            <div class="card-header" style="padding:12px;">
                                <h3 class="card-title" style="font-size:0.9rem;">Web Senaryolari</h3>
                                <button class="btn btn-ghost btn-sm" onclick="newScenario()">+ Yeni</button>
                            </div>
                            <div class="card-body scenario-list" id="scenarioList" style="padding:10px;"></div>
                        </div>
                    </div>
                    
                    <!-- Center Panel - Editor -->
                    <div class="center-panel">
                        <div class="editor-box">
                            <div class="editor-header">
                                <input type="text" id="scenarioName" placeholder="Senaryo adi...">
                                <button class="btn btn-ghost btn-sm" onclick="saveScenario()">üíæ Kaydet</button>
                            </div>
                            <div class="editor-body">
                                <textarea id="stepsEditor" placeholder="Turkce test adimlari yazin...

Ornek:
1. 2 saniye beklenir
2. &quot;Giris Yap&quot; butonuna tiklanir
3. &quot;Email&quot; alanina test@test.com yazilir
4. &quot;Sifre&quot; alanina 123456 yazilir
5. &quot;Gonder&quot; butonuna tiklanir
6. &quot;Hos geldiniz&quot; yazisi gorulur"></textarea>
                            </div>
                            <div class="editor-footer">
                                <button class="btn btn-secondary btn-sm" onclick="parseSteps()">üîç Kontrol Et</button>
                                <button class="btn btn-success" onclick="runTest()" id="btnRun">‚ñ∂ Calistir</button>
                            </div>
                        </div>
                        
                        <!-- Quick Actions -->
                        <div style="padding: 8px 0;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 6px;">Hizli Ekle:</div>
                            <div class="quick-actions">
                                <span class="quick-action" onclick="insertStep('2 saniye beklenir')">‚è± Bekle</span>
                                <span class="quick-action" onclick="insertStep('\"Buton\" butonuna tiklanir')">üëÜ Tikla</span>
                                <span class="quick-action" onclick="insertStep('\"Alan\" alanina metin yazilir')">‚úèÔ∏è Yaz</span>
                                <span class="quick-action" onclick="insertStep('\"Metin\" yazisi gorulur')">üëÅ Dogrula</span>
                                <span class="quick-action" onclick="insertStep('Sayfa asagi kaydirilir')">‚¨á Scroll</span>
                                <span class="quick-action" onclick="insertStep('Geri tusuna basilir')">‚óÄ Geri</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Panel - Settings & Results -->
                    <div class="right-panel">
                        <div class="settings-section">
                            <div class="settings-section-header">üåê Test Ayarlari</div>
                            <div class="settings-section-body">
                                <div class="form-group" style="margin-bottom:10px;">
                                    <label class="form-label" style="font-size:0.8rem;">Baslangic URL</label>
                                    <input type="url" class="form-input" id="webUrl" placeholder="https://example.com" style="font-size:0.85rem; padding:8px 12px;">
                                </div>
                                <div class="toggle-group" style="padding:6px 0;">
                                    <span style="font-size:0.85rem;">Headless (Arka Plan)</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="headless">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-group" style="padding:6px 0; border-bottom:none;">
                                    <span style="font-size:0.85rem;">Hatada Dur</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="stopOnFail" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="result-box">
                            <div class="result-header">
                                <span>üìä Test Sonucu</span>
                                <span id="resultStatus" class="badge badge-warning">Bekleniyor</span>
                            </div>
                            <div class="result-body" id="resultBody">
                                <div style="text-align:center; color:var(--text-muted); padding:30px 10px;">
                                    <div style="font-size:2rem; margin-bottom:8px;">üß™</div>
                                    <div style="font-size:0.85rem;">Test calistirinca sonuclar burada gorunecek</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Help Modal -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal" style="max-width: 550px;">
            <div class="modal-header">
                <h3 class="modal-title">üìñ Turkce Test Adimlari</h3>
                <button class="modal-close" onclick="Modal.hide('helpModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <div style="display:grid; gap:16px;">
                    <div>
                        <h4 style="font-size:0.9rem; margin-bottom:6px; color:var(--accent-primary);">üëÜ Tiklama</h4>
                        <code style="display:block; padding:10px; background:var(--bg-tertiary); border-radius:6px; font-size:0.8rem;">
                            "Giris Yap" butonuna tiklanir<br>
                            "Devam" linkine tiklanir
                        </code>
                    </div>
                    <div>
                        <h4 style="font-size:0.9rem; margin-bottom:6px; color:var(--accent-primary);">‚úèÔ∏è Yazma</h4>
                        <code style="display:block; padding:10px; background:var(--bg-tertiary); border-radius:6px; font-size:0.8rem;">
                            "Email" alanina <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="d7a3b2a4a397a3b2a4a3f9b4b8ba">[email&#160;protected]</a> yazilir<br>
                            "Sifre" kutusuna 123456 girilir
                        </code>
                    </div>
                    <div>
                        <h4 style="font-size:0.9rem; margin-bottom:6px; color:var(--accent-primary);">üëÅ Dogrulama</h4>
                        <code style="display:block; padding:10px; background:var(--bg-tertiary); border-radius:6px; font-size:0.8rem;">
                            "Hos geldiniz" yazisi gorulur<br>
                            "Basarili" metni goruntulenir
                        </code>
                    </div>
                    <div>
                        <h4 style="font-size:0.9rem; margin-bottom:6px; color:var(--accent-primary);">‚è± Bekleme & Diger</h4>
                        <code style="display:block; padding:10px; background:var(--bg-tertiary); border-radius:6px; font-size:0.8rem;">
                            2 saniye beklenir<br>
                            Sayfa asagi kaydirilir<br>
                            Geri tusuna basilir
                        </code>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="js/app.js"></script>
    <script>
        let selectedScenarioId = null;
        
        async function init() {
            if (!Auth.checkAuth()) return;
            UI.renderUserInfo();
            await loadScenarios();
            
            // URL'den senaryo yukle
            const params = new URLSearchParams(location.search);
            const id = params.get('id');
            if (id) selectScenario(parseInt(id));
        }
        
        async function loadScenarios() {
            try {
                const data = await ScenariosAPI.list('web');
                const list = document.getElementById('scenarioList');
                
                if (data.scenarios.length === 0) {
                    list.innerHTML = '<p style="text-align:center; color:var(--text-muted); padding:20px; font-size:0.8rem;">Web senaryo yok</p>';
                    return;
                }
                
                list.innerHTML = data.scenarios.map(s => `
                    <div class="scenario-item ${selectedScenarioId === s.id ? 'selected' : ''}" onclick="selectScenario(${s.id})">
                        <div class="scenario-item-name">${Utils.escapeHtml(s.name)}</div>
                        <div class="scenario-item-meta">${Utils.formatRelativeTime(s.updated_at)}</div>
                    </div>
                `).join('');
            } catch (e) { console.error(e); }
        }
        
        async function selectScenario(id) {
            try {
                const s = await ScenariosAPI.get(id);
                selectedScenarioId = s.id;
                document.getElementById('scenarioName').value = s.name;
                document.getElementById('stepsEditor').value = s.natural_steps || '';
                
                if (s.config_json) {
                    const config = JSON.parse(s.config_json);
                    document.getElementById('webUrl').value = config.url || '';
                    document.getElementById('headless').checked = config.headless || false;
                    document.getElementById('stopOnFail').checked = config.stop_on_fail !== false;
                }
                
                await loadScenarios();
            } catch (e) { Toast.error(e.message); }
        }
        
        function newScenario() {
            selectedScenarioId = null;
            document.getElementById('scenarioName').value = '';
            document.getElementById('stepsEditor').value = '';
            document.getElementById('webUrl').value = '';
            document.querySelectorAll('.scenario-item').forEach(i => i.classList.remove('selected'));
        }
        
        async function saveScenario() {
            const name = document.getElementById('scenarioName').value.trim();
            const steps = document.getElementById('stepsEditor').value;
            
            if (!name) { Toast.error('Senaryo adi gerekli'); return; }
            
            const data = {
                name, type: 'web', natural_steps: steps,
                config_json: JSON.stringify({
                    url: document.getElementById('webUrl').value,
                    headless: document.getElementById('headless').checked,
                    stop_on_fail: document.getElementById('stopOnFail').checked
                })
            };
            
            try {
                if (selectedScenarioId) {
                    await ScenariosAPI.update(selectedScenarioId, data);
                    Toast.success('Guncellendi');
                } else {
                    const result = await ScenariosAPI.create(data);
                    selectedScenarioId = result.id;
                    Toast.success('Kaydedildi');
                }
                await loadScenarios();
            } catch (e) { Toast.error(e.message); }
        }
        
        function insertStep(text) {
            const editor = document.getElementById('stepsEditor');
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const content = editor.value;
            
            // Satir numarasi ekle
            const lines = content.substring(0, start).split('\n');
            const lineNum = lines.length;
            const newLine = (start > 0 && content[start-1] !== '\n') ? '\n' : '';
            const step = newLine + lineNum + '. ' + text + '\n';
            
            editor.value = content.substring(0, start) + step + content.substring(end);
            editor.focus();
            editor.selectionStart = editor.selectionEnd = start + step.length;
        }
        
        async function parseSteps() {
            const text = document.getElementById('stepsEditor').value;
            if (!text.trim()) { Toast.error('Adim yazin'); return; }
            
            try {
                const result = await TestAPI.parseNatural(text, 'web');
                Toast.success(result.count + ' adim bulundu');
            } catch (e) { Toast.error(e.message); }
        }
        
        async function runTest() {
            const steps = document.getElementById('stepsEditor').value;
            if (!steps.trim()) { Toast.error('Adim yazin'); return; }
            
            const btn = document.getElementById('btnRun');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Calisiyor...';
            
            document.getElementById('resultStatus').textContent = 'Calisiyor...';
            document.getElementById('resultStatus').className = 'badge badge-warning';
            document.getElementById('resultBody').innerHTML = '<div style="text-align:center; padding:30px;"><div style="font-size:2rem;">‚è≥</div><div>Test calisiyor...</div></div>';
            
            try {
                const result = await TestAPI.runWebTest({
                    url: document.getElementById('webUrl').value,
                    input_type: 'natural',
                    natural_text: steps,
                    headless: document.getElementById('headless').checked,
                    stop_on_fail: document.getElementById('stopOnFail').checked
                });
                
                renderResult(result);
            } catch (e) {
                document.getElementById('resultStatus').textContent = 'Hata';
                document.getElementById('resultStatus').className = 'badge badge-danger';
                document.getElementById('resultBody').innerHTML = `<div style="color:var(--danger); padding:20px; text-align:center;"><div style="font-size:2rem;">‚ùå</div><div>${e.message}</div></div>`;
                Toast.error(e.message);
            }
            
            btn.disabled = false;
            btn.innerHTML = '‚ñ∂ Calistir';
        }
        
        function renderResult(result) {
            const status = document.getElementById('resultStatus');
            const body = document.getElementById('resultBody');
            
            if (result.success) {
                status.textContent = 'Basarili';
                status.className = 'badge badge-success';
                Toast.success('Test basarili!');
            } else {
                status.textContent = 'Basarisiz';
                status.className = 'badge badge-danger';
                Toast.error(result.message || 'Test basarisiz');
            }
            
            const summary = result.summary || {};
            
            body.innerHTML = `
                <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-bottom:12px;">
                    <div style="text-align:center; padding:10px; background:var(--bg-tertiary); border-radius:6px;">
                        <div style="font-size:1.2rem; font-weight:700;">${summary.executed || 0}</div>
                        <div style="font-size:0.7rem; color:var(--text-muted);">Calistirildi</div>
                    </div>
                    <div style="text-align:center; padding:10px; background:rgba(16,185,129,0.1); border-radius:6px;">
                        <div style="font-size:1.2rem; font-weight:700; color:var(--success);">${summary.passed || 0}</div>
                        <div style="font-size:0.7rem; color:var(--text-muted);">Basarili</div>
                    </div>
                    <div style="text-align:center; padding:10px; background:rgba(239,68,68,0.1); border-radius:6px;">
                        <div style="font-size:1.2rem; font-weight:700; color:var(--danger);">${summary.failed || 0}</div>
                        <div style="font-size:0.7rem; color:var(--text-muted);">Basarisiz</div>
                    </div>
                </div>
                
                <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:8px;">Sure: ${result.duration || 0}s</div>
                
                ${(result.results || []).map((r, i) => `
                    <div class="result-step ${r.success ? 'success' : 'failed'}">
                        <span class="result-step-num">${i + 1}</span>
                        <div class="result-step-content">
                            <div class="result-step-action">${r.action}: ${r.target || ''}</div>
                            ${r.message ? `<div class="result-step-message">${r.message}</div>` : ''}
                        </div>
   