<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Senaryo EditÃ¶rÃ¼ - Test Otomasyon Platformu</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">ğŸ§ª</div>
                    <span>Test Platform</span>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Ana MenÃ¼</div>
                    <a href="index.html" class="nav-item">
                        <span class="nav-item-icon">ğŸ“Š</span>
                        <span>Dashboard</span>
                    </a>
                    <a href="devices.html" class="nav-item">
                        <span class="nav-item-icon">ğŸ“±</span>
                        <span>Cihazlar</span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">YardÄ±m</div>
                    <a href="#" class="nav-item" onclick="showHelpModal(); return false;">
                        <span class="nav-item-icon">â“</span>
                        <span>NasÄ±l YazÄ±lÄ±r?</span>
                    </a>
                </div>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">?</div>
                    <div class="user-details">
                        <div class="user-name">YÃ¼kleniyor...</div>
                        <div class="user-role">-</div>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <a href="index.html" class="btn btn-ghost btn-sm">â† Geri</a>
                    <h1 class="page-title" id="pageTitle">Yeni Senaryo</h1>
                </div>
                <div class="header-right">
                    <button class="theme-toggle" onclick="Theme.toggle()">ğŸŒ™</button>
                    <button class="btn btn-secondary" onclick="parseSteps()">
                        ğŸ” Kontrol Et
                    </button>
                    <button class="btn btn-success" onclick="runTest()">
                        â–¶ï¸ Ã‡alÄ±ÅŸtÄ±r
                    </button>
                    <button class="btn btn-primary" onclick="saveScenario()">
                        ğŸ’¾ Kaydet
                    </button>
                </div>
            </header>
            
            <div class="page-content">
                <div class="editor-container">
                    <!-- Editor Main -->
                    <div class="editor-main">
                        <div class="editor-toolbar">
                            <div class="tabs">
                                <button class="tab active" data-tab="natural">TÃ¼rkÃ§e AdÄ±mlar</button>
                                <button class="tab" data-tab="preview">Ã–nizleme</button>
                            </div>
                        </div>
                        <div class="editor-content">
                            <div id="naturalTab" class="editor-with-lines">
                                <div class="line-numbers" id="lineNumbers">1</div>
                                <textarea class="code-editor" id="stepsEditor" placeholder="Test adÄ±mlarÄ±nÄ±zÄ± TÃ¼rkÃ§e yazÄ±n...

Ã–rnek:
1. 2 saniye beklenir
2. &quot;GiriÅŸ Yap&quot; butonuna tÄ±klanÄ±r
3. &quot;Email&quot; alanÄ±na test@test.com yazÄ±lÄ±r
4. &quot;Åifre&quot; alanÄ±na 123456 yazÄ±lÄ±r
5. &quot;GÃ¶nder&quot; butonuna tÄ±klanÄ±r
6. &quot;HoÅŸ geldiniz&quot; yazÄ±sÄ± gÃ¶rÃ¼lÃ¼r"></textarea>
                            </div>
                            
                            <div id="previewTab" class="card-body" style="display: none;">
                                <div id="previewContent">
                                    <p style="color: var(--text-muted);">AdÄ±mlarÄ± gÃ¶rmek iÃ§in "Kontrol Et" butonuna tÄ±klayÄ±n</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Settings Sidebar -->
                    <div class="editor-sidebar">
                        <!-- Senaryo Bilgileri -->
                        <div class="settings-card">
                            <div class="settings-card-header">
                                <span>ğŸ“</span>
                                Senaryo Bilgileri
                            </div>
                            <div class="settings-card-body">
                                <div class="form-group">
                                    <label class="form-label">Senaryo AdÄ± *</label>
                                    <input type="text" class="form-input" id="scenarioName" placeholder="Ã–rn: Login Testi" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">AÃ§Ä±klama</label>
                                    <textarea class="form-input" id="scenarioDesc" placeholder="Senaryo hakkÄ±nda kÄ±sa aÃ§Ä±klama..." rows="2" style="resize: vertical;"></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Test TÃ¼rÃ¼ *</label>
                                    <select class="form-input form-select" id="scenarioType">
                                        <option value="web">ğŸŒ Web Test</option>
                                        <option value="mobile">ğŸ“² Mobil Test</option>
                                        <option value="desktop">ğŸ–¥ï¸ Desktop Test</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Web Test AyarlarÄ± -->
                        <div class="settings-card" id="webSettings">
                            <div class="settings-card-header">
                                <span>ğŸŒ</span>
                                Web Test AyarlarÄ±
                            </div>
                            <div class="settings-card-body">
                                <div class="form-group">
                                    <label class="form-label">BaÅŸlangÄ±Ã§ URL *</label>
                                    <input type="url" class="form-input" id="webUrl" placeholder="https://example.com">
                                </div>
                                
                                <div class="toggle-group">
                                    <span class="toggle-label">Headless Mod</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="webHeadless">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                
                                <div class="toggle-group">
                                    <span class="toggle-label">Hatada Dur</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="webStopOnFail" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mobil Test AyarlarÄ± -->
                        <div class="settings-card" id="mobileSettings" style="display: none;">
                            <div class="settings-card-header">
                                <span>ğŸ“²</span>
                                Mobil Test AyarlarÄ±
                            </div>
                            <div class="settings-card-body">
                                <div class="form-group">
                                    <label class="form-label">Cihaz SeÃ§</label>
                                    <select class="form-input form-select" id="mobileDevice">
                                        <option value="">Cihaz seÃ§in...</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Uygulama Paketi</label>
                                    <input type="text" class="form-input" id="mobilePackage" placeholder="com.example.app">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Activity (Opsiyonel)</label>
                                    <input type="text" class="form-input" id="mobileActivity" placeholder=".MainActivity">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Desktop Test AyarlarÄ± -->
                        <div class="settings-card" id="desktopSettings" style="display: none;">
                            <div class="settings-card-header">
                                <span>ğŸ–¥ï¸</span>
                                Desktop Test AyarlarÄ±
                            </div>
                            <div class="settings-card-body">
                                <div class="form-group">
                                    <label class="form-label">Uygulama Yolu</label>
                                    <input type="text" class="form-input" id="desktopPath" placeholder="C:\Program Files\App\app.exe">
                                </div>
                                <p style="font-size: 0.8rem; color: var(--text-muted);">
                                    âš ï¸ Desktop test henÃ¼z geliÅŸtirme aÅŸamasÄ±nda
                                </p>
                            </div>
                        </div>
                        
                        <!-- Test Sonucu -->
                        <div class="settings-card" id="resultCard" style="display: none;">
                            <div class="settings-card-header">
                                <span>ğŸ“Š</span>
                                Son Test Sonucu
                            </div>
                            <div class="settings-card-body" id="resultContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Help Modal -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“– TÃ¼rkÃ§e Test AdÄ±mlarÄ± NasÄ±l YazÄ±lÄ±r?</h3>
                <button class="modal-close" onclick="Modal.hide('helpModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <h4 style="margin-bottom: 12px; color: var(--text-primary);">TÄ±klama</h4>
                <code style="display: block; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 16px; color: var(--text-secondary);">
                    "GiriÅŸ Yap" butonuna tÄ±klanÄ±r<br>
                    "Devam Et" linkine tÄ±klanÄ±r
                </code>
                
                <h4 style="margin-bottom: 12px; color: var(--text-primary);">Yazma</h4>
                <code style="display: block; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 16px; color: var(--text-secondary);">
                    "Email" alanÄ±na test@test.com yazÄ±lÄ±r<br>
                    "Åifre" kutusuna 123456 girilir
                </code>
                
                <h4 style="margin-bottom: 12px; color: var(--text-primary);">DoÄŸrulama</h4>
                <code style="display: block; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 16px; color: var(--text-secondary);">
                    "HoÅŸ geldiniz" yazÄ±sÄ± gÃ¶rÃ¼lÃ¼r<br>
                    "BaÅŸarÄ±lÄ±" metni gÃ¶rÃ¼ntÃ¼lenir
                </code>
                
                <h4 style="margin-bottom: 12px; color: var(--text-primary);">Bekleme</h4>
                <code style="display: block; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 16px; color: var(--text-secondary);">
                    2 saniye beklenir<br>
                    5 sn beklenir
                </code>
                
                <h4 style="margin-bottom: 12px; color: var(--text-primary);">DiÄŸer</h4>
                <code style="display: block; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; color: var(--text-secondary);">
                    Sayfa aÅŸaÄŸÄ± kaydÄ±rÄ±lÄ±r<br>
                    Sayfa yukarÄ± kaydÄ±rÄ±lÄ±r<br>
                    Geri tuÅŸuna basÄ±lÄ±r<br>
                    Sayfa yenilenir
                </code>
            </div>
        </div>
    </div>
    
    <script src="js/app.js"></script>
    <script>
        // Check auth
        if (!Auth.checkAuth()) {}
        
        let currentScenarioId = null;
        let isEditing = false;
        
        async function init() {
            UI.renderUserInfo();
            
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            
            if (id) {
                isEditing = true;
                currentScenarioId = parseInt(id);
                await loadScenario(currentScenarioId);
            }
            
            loadDevices();
            setupEventListeners();
        }
        
        async function loadScenario(id) {
            try {
                const scenario = await ScenariosAPI.get(id);
                
                document.getElementById('pageTitle').textContent = 'Senaryo DÃ¼zenle';
                document.getElementById('scenarioName').value = scenario.name;
                document.getElementById('scenarioDesc').value = scenario.description || '';
                document.getElementById('scenarioType').value = scenario.type;
                document.getElementById('stepsEditor').value = scenario.natural_steps || '';
                
                if (scenario.config_json) {
                    const config = JSON.parse(scenario.config_json);
                    if (scenario.type === 'web') {
                        document.getElementById('webUrl').value = config.url || '';
                        document.getElementById('webHeadless').checked = config.headless || false;
                        document.getElementById('webStopOnFail').checked = config.stop_on_fail !== false;
                    } else if (scenario.type === 'mobile') {
                        document.getElementById('mobilePackage').value = config.app_package || '';
                        document.getElementById('mobileActivity').value = config.app_activity || '';
                    }
                }
                
                updateSettingsVisibility(scenario.type);
                updateLineNumbers();
            } catch (error) {
                Toast.error('Senaryo yÃ¼klenemedi');
            }
        }
        
        async function loadDevices() {
            try {
                const data = await DevicesAPI.list();
                const select = document.getElementById('mobileDevice');
                
                data.devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.id;
                    option.textContent = `${device.name} (${device.os} ${device.os_version}) - ${device.status === 'available' ? 'âœ…' : 'ğŸ”’'}`;
                    option.disabled = device.status !== 'available' && device.current_user_id !== Auth.getUser()?.id;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Devices load error:', error);
            }
        }
        
        function setupEventListeners() {
            document.getElementById('scenarioType').addEventListener('change', (e) => {
                updateSettingsVisibility(e.target.value);
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    const tabName = tab.dataset.tab;
                    document.getElementById('naturalTab').style.display = tabName === 'natural' ? 'flex' : 'none';
                    document.getElementById('previewTab').style.display = tabName === 'preview' ? 'block' : 'none';
                });
            });
            
            const editor = document.getElementById('stepsEditor');
            editor.addEventListener('input', updateLineNumbers);
            editor.addEventListener('scroll', () => {
                document.getElementById('lineNumbers').scrollTop = editor.scrollTop;
            });
            
            updateLineNumbers();
        }
        
        function updateSettingsVisibility(type) {
            document.getElementById('webSettings').style.display = type === 'web' ? 'block' : 'none';
            document.getElementById('mobileSettings').style.display = type === 'mobile' ? 'block' : 'none';
            document.getElementById('desktopSettings').style.display = type === 'desktop' ? 'block' : 'none';
        }
        
        function updateLineNumbers() {
            const editor = document.getElementById('stepsEditor');
            const lines = editor.value.split('\n').length;
            document.getElementById('lineNumbers').innerHTML = Array.from({length: lines}, (_, i) => i + 1).join('<br>');
        }
        
        function showHelpModal() {
            Modal.show('helpModal');
        }
        
        async function parseSteps() {
            const text = document.getElementById('stepsEditor').value;
            const type = document.getElementById('scenarioType').value;
            
            if (!text.trim()) {
                Toast.error('LÃ¼tfen test adÄ±mlarÄ± yazÄ±n');
                return;
            }
            
            try {
                const result = await TestAPI.parseNatural(text, type);
                
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelector('[data-tab="preview"]').classList.add('active');
                document.getElementById('naturalTab').style.display = 'none';
                document.getElementById('previewTab').style.display = 'block';
                
                const previewContent = document.getElementById('previewContent');
                if (result.count === 0) {
                    previewContent.innerHTML = '<p style="color: var(--text-muted);">HiÃ§ adÄ±m bulunamadÄ±. LÃ¼tfen formatÄ± kontrol edin.</p>';
                } else {
                    previewContent.innerHTML = `
                        <p style="margin-bottom: 16px;"><strong>${result.count}</strong> adÄ±m bulundu:</p>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            ${result.steps.map((step, i) => `
                                <div style="display: flex; gap: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                                    <span style="color: var(--text-muted);">${i + 1}.</span>
                                    <div>
                                        <strong style="color: var(--accent-primary);">${step.action}</strong>
                                        ${step.target ? `: "${step.target}"` : ''}
                                        ${step.value ? ` â†’ "${step.value}"` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                Toast.success(`${result.count} adÄ±m bulundu`);
            } catch (error) {
                Toast.error(error.message);
            }
        }
        
        async function saveScenario() {
            const name = document.getElementById('scenarioName').value.trim();
            const description = document.getElementById('scenarioDesc').value.trim();
            const type = document.getElementById('scenarioType').value;
            const naturalSteps = document.getElementById('stepsEditor').value;
            
            if (!name) {
                Toast.error('Senaryo adÄ± gerekli');
                return;
            }
            
            let config = {};
            if (type === 'web') {
                config = {
                    url: document.getElementById('webUrl').value,
                    headless: document.getElementById('webHeadless').checked,
                    stop_on_fail: document.getElementById('webStopOnFail').checked
                };
            } else if (type === 'mobile') {
                config = {
                    device_id: document.getElementById('mobileDevice').value,
                    app_package: document.getElementById('mobilePackage').value,
                    app_activity: document.getElementById('mobileActivity').value
                };
            } else if (type === 'desktop') {
                config = { app_path: document.getElementById('desktopPath').value };
            }
            
            const data = {
                name,
                description,
                type,
                natural_steps: naturalSteps,
                config_json: JSON.stringify(config)
            };
            
            try {
                if (isEditing) {
                    await ScenariosAPI.update(currentScenarioId, data);
                    Toast.success('Senaryo gÃ¼ncellendi');
                } else {
                    const result = await ScenariosAPI.create(data);
                    currentScenarioId = result.id;
                    isEditing = true;
                    document.getElementById('pageTitle').textContent = 'Senaryo DÃ¼zenle';
                    window.history.replaceState({}, '', `editor.html?id=${result.id}`);
                    Toast.success('Senaryo kaydedildi');
                }
            } catch (error) {
                Toast.error(error.message);
            }
        }
        
        async function runTest() {
            const type = document.getElementById('scenarioType').value;
            const naturalSteps = document.getElementById('stepsEditor').value;
            
            if (!naturalSteps.trim()) {
                Toast.error('LÃ¼tfen test adÄ±mlarÄ± yazÄ±n');
                return;
            }
            
            const resultCard = document.getElementById('resultCard');
            const resultContent = document.getElementById('resultContent');
            resultCard.style.display = 'block';
            resultContent.innerHTML = '<p>â³ Test Ã§alÄ±ÅŸÄ±yor...</p>';
            
            try {
                let result;
                
                if (type === 'web') {
                    result = await TestAPI.runWebTest({
                        url: document.getElementById('webUrl').value,
                        input_type: 'natural',
                        natural_text: naturalSteps,
                        headless: document.getElementById('webHeadless').checked,
                        stop_on_fail: document.getElementById('webStopOnFail').checked
                    });
                } else if (type === 'mobile') {
                    const deviceId = document.getElementById('mobileDevice').value;
                    if (!deviceId) {
                        Toast.error('LÃ¼tfen bir cihaz seÃ§in');
                        resultContent.innerHTML = '<p style="color: var(--danger);">Cihaz seÃ§ilmedi</p>';
                        return;
                    }
                    
                    result = await TestAPI.runMobileTest({
                        device_id: parseInt(deviceId),
                        app_package: document.getElementById('mobilePackage').value,
                        app_activity: document.getElementById('mobileActivity').value,
                        input_type: 'natural',
                        natural_text: naturalSteps,
                        stop_on_fail: true
                    });
                } else {
                    Toast.error('Desktop test henÃ¼z desteklenmiyor');
                    resultContent.innerHTML = '<p style="color: var(--warning);">Desktop test henÃ¼z geliÅŸtirme aÅŸamasÄ±nda</p>';
                    return;
                }
                
                renderResult(result);
            } catch (error) {
                resultContent.innerHTML = `<p style="color: var(--danger);">âŒ Hata: ${error.message}</p>`;
                Toast.error(error.message);
            }
        }
        
        function renderResult(result) {
            const resultContent = document.getElementById('resultContent');
            const statusIcon = result.success ? 'âœ…' : 'âŒ';
            const statusClass = result.success ? 'success' : 'danger';
            const summary = result.summary || {};
            
            resultContent.innerHTML = `
                <div style="text-align: center; margin-bottom: 16px;">
                    <span style="font-size: 2rem;">${statusIcon}</span>
                    <p style="font-weight: 600; color: var(--${statusClass});">
                        ${result.success ? 'Test BaÅŸarÄ±lÄ±' : 'Test BaÅŸarÄ±sÄ±z'}
                    </p>
                    <p style="font-size: 0.85rem; color: var(--text-muted);">${result.duration || 0}s</p>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 16px;">
                    <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700;">${summary.executed || 0}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">Ã‡alÄ±ÅŸtÄ±rÄ±ldÄ±</div>
                    </div>
                    <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);">${summary.passed || 0}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">BaÅŸarÄ±lÄ±</div>
                    </div>
                </div>
                
                ${result.results?.length ? `
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${result.results.map((r, i) => `
                            <div style="display: flex; align-items: center; gap: 8px; padding: 8px; border-bottom: 1px solid var(--border-light); font-size: 0.85rem;">
                                <span>${r.success ? 'âœ…' : 'âŒ'}</span>
                                <span style="color: var(--text-muted);">${i + 1}.</span>
                                <span>${r.action}: ${r.target || ''}</span>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            `;
            
            result.success ? Toast.success('Test baÅŸarÄ±yla tamamlandÄ±!') : Toast.error(result.message || 'Test baÅŸarÄ±sÄ±z');
        }
        
        init();
    </script>
</body>
</html>
