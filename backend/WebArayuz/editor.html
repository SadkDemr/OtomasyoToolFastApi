<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Senaryo Editoru - Test Otomasyon Platformu</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo"><div class="logo-icon">üß™</div><span>Test Platform</span></div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Ana Menu</div>
                    <a href="index.html" class="nav-item"><span class="nav-item-icon">üìä</span><span>Dashboard</span></a>
                    <a href="scenarios.html" class="nav-item"><span class="nav-item-icon">üìù</span><span>Senaryolar</span></a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Test Turleri</div>
                    <a href="web-test.html" class="nav-item"><span class="nav-item-icon">üåê</span><span>Web Test</span></a>
                    <a href="mobile-test.html" class="nav-item"><span class="nav-item-icon">üì≤</span><span>Mobil Test</span></a>
                    <a href="desktop-test.html" class="nav-item"><span class="nav-item-icon">üñ•Ô∏è</span><span>Desktop Test</span></a>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info" onclick="if(confirm('Cikis?')) Auth.logout();">
                    <div class="user-avatar">?</div>
                    <div class="user-details"><div class="user-name">Yukleniyor...</div><div class="user-role">-</div></div>
                </div>
            </div>
        </aside>
        
        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <a href="scenarios.html" class="btn btn-ghost btn-sm">‚Üê Geri</a>
                    <h1 class="page-title" id="pageTitle">Yeni Senaryo</h1>
                </div>
                <div class="header-right">
                    <button class="theme-toggle" onclick="Theme.toggle()">üåô</button>
                    <button class="btn btn-secondary" onclick="parseSteps()">üîç Kontrol Et</button>
                    <button class="btn btn-primary" onclick="saveScenario()">üíæ Kaydet</button>
                </div>
            </header>
            
            <div class="page-content">
                <div class="editor-layout">
                    <div class="editor-main">
                        <div class="editor-toolbar">
                            <span style="font-weight: 600;">‚úèÔ∏è Test Adimlari</span>
                            <button class="btn btn-ghost btn-sm" onclick="Modal.show('helpModal')">‚ùì Yardim</button>
                        </div>
                        <div class="editor-content">
                            <textarea class="code-editor" id="stepsEditor" placeholder="Test adimlarinizi Turkce yazin...

Ornek:
1. 2 saniye beklenir
2. &quot;Giris Yap&quot; butonuna tiklanir
3. &quot;Email&quot; alanina test@test.com yazilir
4. &quot;Sifre&quot; alanina 123456 yazilir
5. &quot;Gonder&quot; butonuna tiklanir
6. &quot;Hos geldiniz&quot; yazisi gorulur"></textarea>
                        </div>
                    </div>
                    
                    <div class="editor-sidebar">
                        <div class="settings-card">
                            <div class="settings-card-header">üìù Senaryo Bilgileri</div>
                            <div class="settings-card-body">
                                <div class="form-group">
                                    <label class="form-label">Senaryo Adi *</label>
                                    <input type="text" class="form-input" id="scenarioName" placeholder="Ornek: Login Testi">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Aciklama</label>
                                    <textarea class="form-input" id="scenarioDesc" rows="2" placeholder="Kisa aciklama..."></textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Test Turu *</label>
                                    <select class="form-input form-select" id="scenarioType" onchange="updateSettings()">
                                        <option value="web">üåê Web Test</option>
                                        <option value="mobile">üì≤ Mobil Test</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="settings-card" id="webSettings">
                            <div class="settings-card-header">üåê Web Ayarlari</div>
                            <div class="settings-card-body">
                                <div class="form-group">
                                    <label class="form-label">Baslangic URL</label>
                                    <input type="url" class="form-input" id="webUrl" placeholder="https://example.com">
                                </div>
                                <div class="toggle-group">
                                    <span>Headless Mod</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="webHeadless">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-group">
                                    <span>Hatada Dur</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="webStopOnFail" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="settings-card" id="mobileSettings" style="display:none;">
                            <div class="settings-card-header">üì≤ Mobil Ayarlari</div>
                            <div class="settings-card-body">
                                <div class="form-group">
                                    <label class="form-label">Uygulama Paketi</label>
                                    <input type="text" class="form-input" id="appPackage" placeholder="com.example.app">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Activity</label>
                                    <input type="text" class="form-input" id="appActivity" placeholder=".MainActivity">
                                </div>
                            </div>
                        </div>
                        
                        <div class="settings-card" id="parseResult" style="display:none;">
                            <div class="settings-card-header">üîç Adim Onizleme</div>
                            <div class="settings-card-body" id="parseContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Help Modal -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Test Adimlari Nasil Yazilir?</h3>
                <button class="modal-close" onclick="Modal.hide('helpModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <h4 style="margin-bottom:8px;">Tiklama</h4>
                <code style="display:block; padding:12px; background:var(--bg-tertiary); border-radius:8px; margin-bottom:16px;">
                    "Giris Yap" butonuna tiklanir<br>
                    "Devam Et" linkine tiklanir
                </code>
                
                <h4 style="margin-bottom:8px;">Yazma</h4>
                <code style="display:block; padding:12px; background:var(--bg-tertiary); border-radius:8px; margin-bottom:16px;">
                    "Email" alanina test@test.com yazilir<br>
                    "Sifre" kutusuna 123456 girilir
                </code>
                
                <h4 style="margin-bottom:8px;">Dogrulama</h4>
                <code style="display:block; padding:12px; background:var(--bg-tertiary); border-radius:8px; margin-bottom:16px;">
                    "Hos geldiniz" yazisi gorulur<br>
                    "Basarili" metni goruntulenir
                </code>
                
                <h4 style="margin-bottom:8px;">Bekleme</h4>
                <code style="display:block; padding:12px; background:var(--bg-tertiary); border-radius:8px; margin-bottom:16px;">
                    2 saniye beklenir<br>
                    5 sn beklenir
                </code>
                
                <h4 style="margin-bottom:8px;">Diger</h4>
                <code style="display:block; padding:12px; background:var(--bg-tertiary); border-radius:8px;">
                    Sayfa asagi kaydirilir<br>
                    Geri tusuna basilir<br>
                    Sayfa yenilenir
                </code>
            </div>
        </div>
    </div>
    
    <script src="js/app.js"></script>
    <script>
        if (!Auth.checkAuth()) {}
        
        let currentId = null;
        
        async function init() {
            UI.renderUserInfo();
            
            const params = new URLSearchParams(location.search);
            const id = params.get('id');
            if (id) {
                currentId = parseInt(id);
                await loadScenario(currentId);
            }
        }
        
        async function loadScenario(id) {
            try {
                const s = await ScenariosAPI.get(id);
                document.getElementById('pageTitle').textContent = 'Senaryo Duzenle';
                document.getElementById('scenarioName').value = s.name;
                document.getElementById('scenarioDesc').value = s.description || '';
                document.getElementById('scenarioType').value = s.type;
                document.getElementById('stepsEditor').value = s.natural_steps || '';
                
                if (s.config_json) {
                    const config = JSON.parse(s.config_json);
                    if (s.type === 'web') {
                        document.getElementById('webUrl').value = config.url || '';
                        document.getElementById('webHeadless').checked = config.headless || false;
                        document.getElementById('webStopOnFail').checked = config.stop_on_fail !== false;
                    } else {
                        document.getElementById('appPackage').value = config.app_package || '';
                        document.getElementById('appActivity').value = config.app_activity || '';
                    }
                }
                
                updateSettings();
            } catch (e) { Toast.error('Yukleme hatasi'); }
        }
        
        function updateSettings() {
            const type = document.getElementById('scenarioType').value;
            document.getElementById('webSettings').style.display = type === 'web' ? 'block' : 'none';
            document.getElementById('mobileSettings').style.display = type === 'mobile' ? 'block' : 'none';
        }
        
        async function parseSteps() {
            const text = document.getElementById('stepsEditor').value;
            const type = document.getElementById('scenarioType').value;
            
            if (!text.trim()) { Toast.error('Adim yazin'); return; }
            
            try {
                const result = await TestAPI.parseNatural(text, type);
                
                const card = document.getElementById('parseResult');
                const content = document.getElementById('parseContent');
                card.style.display = 'block';
                
                if (result.count === 0) {
                    content.innerHTML = '<p style="color:var(--text-muted);">Adim bulunamadi</p>';
                } else {
                    content.innerHTML = `
                        <p style="margin-bottom:12px;"><strong>${result.count}</strong> adim bulundu:</p>
                        ${result.steps.map((s, i) => `
                            <div style="padding:8px; background:var(--bg-tertiary); border-radius:6px; margin-bottom:6px; font-size:0.85rem;">
                                <span style="color:var(--text-muted);">${i+1}.</span>
                                <strong style="color:var(--accent-primary);">${s.action}</strong>
                                ${s.target ? `: "${s.target}"` : ''}
                                ${s.value ? ` ‚Üí "${s.value}"` : ''}
                            </div>
                        `).join('')}
                    `;
                }
                
                Toast.success(result.count + ' adim bulundu');
            } catch (e) { Toast.error(e.message); }
        }
        
        async function saveScenario() {
            const name = document.getElementById('scenarioName').value.trim();
            const type = document.getElementById('scenarioType').value;
            
            if (!name) { Toast.error('Senaryo adi gerekli'); return; }
            
            let config = {};
            if (type === 'web') {
                config = {
                    url: document.getElementById('webUrl').value,
                    headless: document.getElementById('webHeadless').checked,
                    stop_on_fail: document.getElementById('webStopOnFail').checked
                };
            } else {
                config = {
                    app_package: document.getElementById('appPackage').value,
                    app_activity: document.getElementById('appActivity').value
                };
            }
            
            const data = {
                name,
                description: document.getElementById('scenarioDesc').value,
                type,
                natural_steps: document.getElementById('stepsEditor').value,
                config_json: JSON.stringify(config)
            };
            
            try {
                if (currentId) {
                    await ScenariosAPI.update(currentId, data);
                    Toast.success('Guncellendi');
                } else {
                    const result = await ScenariosAPI.create(data);
                    currentId = result.id;
                    document.getElementById('pageTitle').textContent = 'Senaryo Duzenle';
                    history.replaceState({}, '', 'editor.html?id=' + result.id);
                    Toast.success('Kaydedildi');
                }
            } catch (e) { Toast.error(e.message); }
        }
        
        init();
    </script>
</body>
</html>
